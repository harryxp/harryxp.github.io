<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <title>Peachful Space - SSH Config for Advanced Users</title>
        <link href="https://fonts.googleapis.com/css?family=Work+Sans" rel="stylesheet">
        <link rel="stylesheet" type="text/css" href="../css/default.css" />
    </head>
    <body>
        <div id="header">
            <div id="logo">
                <a href="../">Peachful Space</a>
            </div>
            <div id="navigation">
                <a href="../">Home</a>
                <a href="../about.html">About</a>
                <a href="../archive.html">Archive</a>
            </div>
        </div>

        <div id="content">
            <h1>SSH Config for Advanced Users</h1>

            <div class="info">
    Posted on June 29, 2016
    
</div>

<p>I'm sure that with the popularity of websites like github.com and the ubiquitous remote working, many people face issues like these:</p>
<ol style="list-style-type: decimal">
<li><p>You have a personal bitbucket account, and a company one, and the SSH key files of them don't play well with each other. When you do a <code>git fetch</code>, you'll never know which key file <code>git</code> (actually <code>ssh</code>) uses, and more often than not, it chooses the wrong key. You can use <code>ssh-add</code> to switch keys, but that's so tedious, and it feels so wrong.</p></li>
<li><p>You need to access your company's internal hosts via a “proxy” host, to which you have SSH access. You can <code>ssh</code> to it and <code>ssh</code> from there to reach your final destinations. But again, it feels so wrong.</p></li>
</ol>
<p>The solutions are <code>IdentitiesOnly</code> and <code>ProxyCommand</code>. Here's my <code>~/.ssh/config</code>:</p>
<pre><code>ForwardAgent yes
IdentitiesOnly yes
ServerAliveInterval 30

Host github.com                             # this is a simple entry for github
    User git
    IdentityFile ~/.ssh/id_rsa_github

Host bitbucket-personal                     # two bitbucket accounts using different key files
    User git                                # note that User is always git, same for github
    HostName bitbucket.org
    IdentityFile ~/.ssh/id_rsa_bitbucket

Host bitbucket-company
    User git
    HostName bitbucket.org
    IdentityFile ~/.ssh/id_rsa_company

Host company-proxy                          # proxy host
    User harry
    HostName proxy.mycompany.com
    IdentityFile ~/.ssh/id_rsa_company

Host *.mycompany.com                        # wildcard pattern for internal company hosts;  in my case host names can only be resolved inside company's network so you can't really ssh to it directly
    User harry
    ProxyCommand ssh -W %h:%p company-proxy # actually this can be any command, but eventually it should connect
    IdentityFile ~/.ssh/id_rsa_company</code></pre>
<p>Now, in order to take advantage of the two bitbucket accounts, you need to do <code>git clone</code> using the aliases:</p>
<pre><code>git clone git@bitbucket-personal:HarryPan/blog.git
git clone git@bitbucket-company:CompanyUser/lucrative-business.git</code></pre>
<p>Or if the repositories are already cloned, <code>git remote set-url origin</code> might be what you need.</p>
<p><a href="http://superuser.com/a/436015">chrishiestand's answer</a> explains <code>IdentitiesOnly</code> very well:</p>
<blockquote>
<p>Firstly, unlike every other option in ssh_config, ssh does not use the first IdentityFile that it finds. Instead the IdentityFile option adds that file to a list of identities used. You may stack multiple IdentityFile options, and the ssh client will try them all until the server accepts one or rejects the connection.</p>
</blockquote>
<blockquote>
<p>Second, if you use an ssh-agent, ssh will automatically try to use the keys in the agent, even if you have not specified them with in ssh_config's IdentityFile (or -i) option. This is a common reason you might get the Too many authentication failures for user error. Using the IdentitiesOnly yes option will disable this behavior.</p>
</blockquote>
<blockquote>
<p>If you ssh as multiple users to multiple systems, I recommend putting IdentitiesOnly yes in your global section of ssh_config, and putting each IdentityFile within the appropriate Host subsections.</p>
</blockquote>

        </div>
        <div id="footer">
            Site proudly generated by
            <a href="http://jaspervdj.be/hakyll">Hakyll</a>
        </div>
    </body>
</html>
